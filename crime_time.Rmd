---
title: "Crime_time"
author: "Zexu Yuan"
date: "11/14/2021"
output: 
  html_document: 
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup}
library(tidyverse)
library(readxl)
library(httr)
library(lubridate)
library(plotly)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "Reds",
  ggplot2.continuous.fill = "Reds"
)
 scale_colour_discrete = scale_color_brewer(palette = "Reds")
 scale_fill_discrete = scale_color_brewer(palette = "Reds")
```

## Import dataset and Tidy data

```{r}
raw_sub_crime = 
  read_csv("./data/subwaycrime.csv") %>% 
  janitor::clean_names() %>% 
  rename("start_date" = "cmplnt_fr_dt", "start_time" = "cmplnt_fr_tm", "end_date" = "cmplnt_to_dt", "end_time" = "cmplnt_to_tm", "law_cat" = "law_cat_cd", "crime_event" = "ofns_desc") %>% 
  mutate(start_date = as.character(as.Date(start_date, "%m/%d/%Y")), 
         end_date = as.character(as.Date(end_date, "%m/%d/%Y"))) %>% 
  filter(start_date > "2021-01-01") %>% 
  mutate(start = as.POSIXct(paste(start_date, start_time), format = "%Y-%m-%d %H:%M:%S"), 
         end = as.POSIXct(paste(end_date, end_time), format = "%Y-%m-%d %H:%M:%S"))
```

# Crime event v.s. Month

## The number of cirime events each month

```{r}
sub_crime_month = 
  raw_sub_crime %>% 
  select(start_date, start_time, crime_event, law_cat) %>% 
  mutate(start_date = substring(start_date, 1, 7))
  
plot_1 = 
  sub_crime_month %>% 
  group_by(start_date) %>% 
  summarise(event_num = n()) %>% 
  plot_ly(
    x = ~start_date, y = ~event_num, type = "bar"
  )

layout(plot_1, title = "Crime events over month", xaxis = list(title = "Month"), yaxis = list(title = "Number of Crime Events"))
```

## The number of crime events each day

```{r}
sub_crime_day = 
  raw_sub_crime %>% 
  select(start_date, start_time, crime_event, law_cat) %>% 
  group_by(start_date) %>% 
  summarise(event_num = n())
  
plot_2 = 
  sub_crime_day %>% 
    plot_ly(
    x = ~start_date, y = ~event_num, type = "scatter", mode = "markers"
  )

layout(plot_2, title = "Crime events over day", xaxis = list(title = "Day"), yaxis = list(title = "Number of Crime Events"))
```

# 3 degrees of crime events

```{r}
sub_crime_degree = 
  raw_sub_crime %>% 
  group_by(start_date, law_cat) %>% 
  summarize(event_num = n())

plot_3 = 
  sub_crime_degree %>% 
    plot_ly(
    x = ~start_date, y = ~event_num, type = "scatter", mode = "marker", color= ~law_cat, colors = c("#66C2A5","#FC8D62","#8DA0CB")
  )

layout(plot_3, title = "3 Degrees of Crime Events Numbers Over Time", xaxis = list(title = "Month"), yaxis = list(title = "Number of Crime Events"))
```

## Crime events v.s. Occurrence time

```{r}
sub_crime_time = 
  raw_sub_crime %>% 
  mutate(
    event_time = as.character(case_when(
      hms("00:00:00") <= start_time & start_time < hms("04:00:00") ~hms("02:00:00"),
      hms("04:00:00") <= start_time & start_time < hms("08:00:00") ~hms("06:00:00"),
      hms("08:00:00") <= start_time & start_time < hms("12:00:00") ~hms("10:00:00"),
      hms("12:00:00") <= start_time & start_time < hms("16:00:00") ~hms("14:00:00"),
      hms("16:00:00") <= start_time & start_time < hms("20:00:00") ~hms("18:00:00"),
      hms("20:00:00") <= start_time & start_time < hms("24:00:00") ~hms("22:00:00")
    ))
  )

plot_4 = 
  sub_crime_time %>% 
  mutate(event_time = as.factor(event_time)) %>% 
  ggplot(aes(x = event_time %>% fct_infreq(), fill = crime_event)) + 
  geom_histogram(stat = "count", width = 0.9, height = 2) + 
  labs(
    title = "Frequency of crime events v.s. Time points", 
    x = "Occurrence time", 
    y = "Frequency of crime events") + 
  theme_bw() + 
  theme(
    plot.title = element_text(hjust = 1), 
    legend.position = "bottom",
    legend.text = element_text(size = 8)) + 
  guides(col = guide_legend(nrow = 2))

ggplotly(plot_4) %>%
  layout(legend = list(
      orientation = "h",
      xanchor = "center",
      yanchor = "top",
      x = 0.3,
      y = - 0.3
    )
  )
```

## Response time

```{r}
crime_response_time = 
  raw_sub_crime %>% 
  select(start_date, start_time, end_date, end_time, crime_event, law_cat_cd) %>% 
  drop_na(start_time, end_time) %>%
  filter(crime_event %in% c("CRIMINAL MISCHIEF & RELATED OF", "ASSAULT 3 & RELATED OFFENSES","HARRASSMENT 2","GRAND LARCENY","DANGEROUS DRUGS","FELONY ASSAULT","ROBBERY","PETIT LARCENY","FORGERY","SEX CRIMES","OFF. AGNST PUB ORD SENSBLTY &","DANGEROUS WEAPONS")) %>% 
  mutate(start = as.POSIXct(paste(start_date, start_time), format = "%Y-%m-%d %H:%M:%S"), 
         end = as.POSIXct(paste(end_date, end_time), format = "%Y-%m-%d %H:%M:%S")) %>% 
  mutate(response_time = difftime(end, start, units = "hours")) %>% 
  mutate(date = substring(start_date,1,7)) %>% 
   mutate(
    event_time = as.character(case_when(
      hms("00:00:00") <= start_time & start_time < hms("04:00:00") ~hms("02:00:00"),
      hms("04:00:00") <= start_time & start_time < hms("08:00:00") ~hms("06:00:00"),
      hms("08:00:00") <= start_time & start_time < hms("12:00:00") ~hms("10:00:00"),
      hms("12:00:00") <= start_time & start_time < hms("16:00:00") ~hms("14:00:00"),
      hms("16:00:00") <= start_time & start_time < hms("20:00:00") ~hms("18:00:00"),
      hms("20:00:00") <= start_time & start_time < hms("24:00:00") ~hms("22:00:00")
    ))
  )

crime_response_time %>% 
  mutate(crime_event = fct_reorder(crime_event, response_time)) %>% 
  plot_ly(y = ~ response_time, color = ~ crime_event, type = "box", colors = "viridis")
```

## heat map: weekdays v.s. occurrence time

```{r}
sub_crime_week = 
  raw_sub_crime %>% 
  tq_transmute(mutate_fun = apply.weekly)
```

