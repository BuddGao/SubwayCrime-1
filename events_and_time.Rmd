---
title: "Crime events and time"
output: 
  html_document: 
    toc: true
    toc_float: true
    code_folding: hide
---

<link rel="stylesheet" href="academicons.css"/>
<link rel="stylesheet" href="styles.css" type="text/css">

```{r setup, echo = FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(readxl)
library(httr)
library(lubridate)
library(plotly)
```

```{r, echo = FALSE, message=FALSE, warning=FALSE}
raw_sub_crime = 
  read_csv("./data/subwaycrime_with_station_new.csv") %>% 
  janitor::clean_names() %>% 
  rename("start_date" = "cmplnt_fr_dt", "start_time" = "cmplnt_fr_tm", "end_date" = "cmplnt_to_dt", "end_time" = "cmplnt_to_tm", "law_cat" = "law_cat_cd", "crime_event" = "ofns_desc", "crime_desc" = "pd_desc") %>% 
  mutate(law_cat = ordered(law_cat, level = c("VIOLATION", "MISDEMEANOR", "FELONY"))) %>% 
  mutate(start_date = as.Date(start_date, "%m/%d/%Y"), 
         end_date = as.Date(end_date, "%m/%d/%Y")) %>% 
  mutate(start = as.POSIXct(paste(start_date, start_time), format = "%Y-%m-%d %H:%M:%S"), 
         end = as.POSIXct(paste(end_date, end_time), format = "%Y-%m-%d %H:%M:%S")) %>% 
  mutate(crime_event = tolower(crime_event),
         law_cat = tolower(law_cat),
         crime_desc = tolower(crime_desc)) %>% 
  drop_na(start_time) %>% 
  separate(start_time, into = c("start_time_hour", "event_minute", "event_second"), sep = ":") %>% 
  select(start_date, start_time_hour, end_date, end_time, law_cat, crime_event, crime_desc, start, end) %>% 
  filter(start_date > "2005-12-31")
```


### Number of crime events each year

For the most frequent crime events, they mainly happen in the afternoon, from 12:00 pm to 20:00 pm in the 9 months in 2021. Of these crime events, from 12:00 pm to 20:00 pm, crime mischief is the most frequent happening events. In New York City, criminal mischief includes intentionally damage, participation in the destruction of an abandoned building. 

```{r}
sub_crime_year = 
  raw_sub_crime %>% 
  select(start_date, start_time_hour, crime_event, law_cat) %>% 
  mutate(start_date = substring(start_date, 1, 4))

plot_1 = 
  sub_crime_year %>% 
  group_by(start_date) %>% 
  summarise(event_num = n()) %>% 
  plot_ly(
    x = ~start_date, y = ~event_num, type = "bar"
  )

layout(plot_1, title = "Crime events over years", xaxis = list(title = "Year"), yaxis = list(title = "Number of Crime Events"))
```

### Number of crime events each season

With the degree to weeks, the highest number of crime events appears in the eleventh week, which in the March. It appears that there would be a locally maximum point for around every ten weeks, and there also would be a sudden increase and decrease at the beginning and end of the year, accordingly.

The third degree of assault is the second frequent crime events in that time interval, which includes intention to cause physical injury to another person.

In that time interval, of crime events, the second degree of harassment is the third frequently happening events, which includes the intention to harass, annoy or alarm some person and strike people in some manner or make physical contact with them. 

```{r}
sub_crime_season = 
  raw_sub_crime %>% 
  select(start_date, start_time_hour, crime_event, law_cat) %>% 
  separate(start_date, into = c("year", "month", "day"), sep = "-") %>% 
  mutate(season = case_when(
    month %in% c("01","02","03") ~ "Q1",
    month %in% c("04","05","06") ~ "Q2",
    month %in% c("07","08","09") ~ "Q3",
    month %in% c("10","11","12") ~ "Q4"
  )) %>% 
  mutate(event_quarter = paste(year, season, sep = "-"))
  
plot_2 = 
  sub_crime_season %>% 
  group_by(event_quarter) %>% 
  summarise(event_num = n()) %>% 
  plot_ly(
    x = ~event_quarter, y = ~event_num, type = "scatter", mode = "points"
  )

layout(plot_2, title = "Crime events over quarter", xaxis = list(title = "Quarter"), yaxis = list(title = "Number of Crime Events"))
```

### Number of cirime events each month

Basically, the number of crime events in each month has the comparably same value. Specifically, March has the highest events number, whereas February has the lowest events number; there is a overall increasing number in the number of crime events along with months.

```{r, message=FALSE, warning=FALSE}
sub_crime_month = 
  raw_sub_crime %>% 
  select(start_date, start_time_hour, crime_event, law_cat) %>% 
  mutate(start_date = substring(start_date, 1, 7)) 
  
plot_3 = 
  sub_crime_month %>% 
  group_by(start_date) %>% 
  summarise(event_num = n()) %>% 
  plot_ly(
    x = ~start_date, y = ~event_num, type = "scatter"
  )

layout(plot_3, title = "Crime events over month", xaxis = list(title = "Month"), yaxis = list(title = "Number of Crime Events"))
```

## Degrees of crime event v.s. Occurrence time

Among the top 10 frequent crime events, events with degree violation mainly occurs in the second degree of harassment, and there is basically no other degree events happened in this type of crimes; events with misdemeanor degree mainly happens in the third degree of assault and criminal mischief; and crime events with felony degree almost happen in each crime event among the top 10 most frequent crime events.

```{r, message=FALSE, warning=FALSE}
sub_crime_degree = 
  raw_sub_crime %>% 
  group_by(law_cat, start_time_hour) %>% 
  summarise(event_num = n()) %>% 
  rename("crime_degree" = "law_cat", "hour" = "start_time_hour")

plot_5 = 
  sub_crime_degree %>% 
  plot_ly(
    x = ~ hour, y = ~ crime_degree, z = ~ event_num, type = "heatmap", colors = "YlGn"
  ) %>%
  colorbar(title = "Events Number", x = 1.1, y = 0.8) 

layout(plot_5, title = "Crime frequency: Degree v.s. Hour", xaxis = list(title = "Hour"), yaxis = list(title = "Degree"))
```

## Day of week v.s. Occurrence time

From the heat map, it is easier to be judged that most of crime events were mainly occurred in the afternoon from Tuesday to Thursday. We can say that in the noon around 12:00 pm on Tuesday and Wednesday may be the most dangerous time on in a week, whereas there are not that many crime events on Saturday and Sunday.

```{r, message=FALSE, warning=FALSE}
sub_crime_dow = 
  raw_sub_crime %>% 
  mutate(day_of_week = wday(as.Date(start_date), label=TRUE, abbr = FALSE)) %>% 
  mutate(day_of_week = fct_relevel(day_of_week, "Saturday", "Friday", "Thursday", "Wednesday", "Tuesday", "Monday", "Sunday")) %>% 
  separate(start_time, into = c("hour", "minute", "second"), sep = ":") %>% 
  select(day_of_week, hour, crime_event) %>% 
  group_by(day_of_week, hour) %>% 
  summarise(crime_num = n())

plot_5 = 
  sub_crime_dow %>% 
  plot_ly(
    x = ~ hour, y = ~ day_of_week, z = ~ crime_num, type = "heatmap", colors = "BuPu"
  ) %>%
  colorbar(title = "Events Number", x = 1.1, y = 0.8) 

layout(plot_5, title = "Crime frequency: Day v.s. Hour", xaxis = list(title = "Hour"), yaxis = list(title = "Day of week")
    )
```

## Proceeding time

For the proceeding time, the overall relationship between proceeding time and degrees of crime events if that the median proceeding time depcreases along with the degree of events increase. Excluding some extreme outliers, felony crime events have the largest median proceeding time so the difficulty of dealing with this type of events for official workers may increase the proceeding time; it also has the largest range of proceeding time, it may depend on the specific cases of this type of events; 

For the violation degree of crime events, it has the lowest median proceeding time, so it may be much easier to be delt with for official workers.

```{r, message=FALSE, warning=FALSE}
crime_prcd_time = 
  raw_sub_crime %>% 
  drop_na(start_time, end_time) %>%
  mutate(prcd_time = difftime(end, start, units = "mins")) %>% 
  filter(prcd_time < 35) %>% 
  filter(prcd_time != 0) %>% 
  mutate(quarters = quarters(as.Date(start_date)))

plot_5 = 
  crime_prcd_time %>% 
  plot_ly(y = ~ prcd_time, color = ~ law_cat, type = "box")

layout(plot_5, title = "Crime type", xaxis = list(title = "Proceeding time"), yaxis = list(title = "Crime type v.s. Proceeding time (mins)")
    )
```

